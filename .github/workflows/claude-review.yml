name: Claude Auto Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Check for @claude mention in PR
        id: check_claude
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });

            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber
            });

            const hasClaudeMention = [pr.data.body, ...comments.data.map(c => c.body)]
              .some(body => body && body.includes('@claude'));

            core.setOutput("run_review", hasClaudeMention);

      - name: Checkout repository
        if: steps.check_claude.outputs.run_review == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Automatic PR Review
        if: steps.check_claude.outputs.run_review == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          trigger_phrase: "@claude"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          timeout_minutes: "60"
          allowed_tools: "mcp__github__create_pending_pull_request_review,mcp__github__add_pull_request_review_comment_to_pending_review,mcp__github__submit_pending_pull_request_review,mcp__github__get_pull_request_diff"
          direct_prompt: |
            **【レビュー依頼の場合】**
            このプルリクエスト（PR）をレビューし、GitHub のレビュー機能を使ってフィードバックをしてください。作業は次の手順に沿って進めてください：
            1.  **レビューを開始する:** `mcp__github__create_pending_pull_request_review` を使って、保留中のレビューを開始します。
            2.  **変更内容を確認する:** `mcp__github__get_pull_request_diff` を使って、コードの変更点や行番号を把握します。
            3.  **インラインコメントを追加する:** 改善点や懸念事項があるコードの行には `mcp__github__add_pull_request_review_comment_to_pending_review` を使ってコメントを追加してください。修正方針が明確な場合には積極的にsuggestionを利用してください。
            4.  **レビューを提出する:** `mcp__github__submit_pending_pull_request_review` を使って、イベントタイプを「COMMENT」に設定し、全体のまとめコメントと共にレビューを提出してください（※「REQUEST_CHANGES」は使わないでください）。

            **コメントの書き方に関する重要事項**

            * **インラインコメントの構成:**
                * **結論を先に:** 各インラインコメントの冒頭で、指摘内容の要点を一行で簡潔に述べてください。
                * **理由と提案:** 結論の後に、そのように判断した理由や背景、具体的な修正案を詳しく説明してください。
                * **指摘中心に:** インラインコメントは、修正提案、バグの可能性、可読性の問題など、具体的な改善点に焦点を当ててください。

            * **ポジティブなフィードバックについて:**
                * **インラインでは控えめに:** インラインで言及するのは、特に優れた設計や他の開発者の参考になるような独創的な実装など、特筆すべき点に限定します。
                * **まとめコメントで言及:** 全体的に良かった点や、PR全体に対するポジティブな感想は、レビュー提出時の「まとめコメント」に集約して記述してください。

            **レビューの観点**

            レビューでは以下の点に注目してください：
            * CLAUDE.mdのガイドラインに従っているか
            * コードの品質やベストプラクティスに沿っているか
            * バグやセキュリティリスクがないか
            * パフォーマンス上の懸念がないか
            * 保守性や可読性は十分か
            * 設計やアーキテクチャに妥当性があるか

            **その他**

            * 日本語でのフィードバックをお願いします。
            * 具体的で実行可能なフィードバックをお願いします。
            * **重要:** レビューの提出は必ず「COMMENT」タイプで行い、PR をブロックしないようにしてください。
